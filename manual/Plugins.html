<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Haraka Manual &raquo; Plugins</title>
    
    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap.css" rel="stylesheet">

    <!-- Documentation extras -->
    <link href="/css/docs.css" rel="stylesheet">
    <link href="/css/pygments-manni.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
      <script src="/js/respond.min.js"></script>
    <![endif]-->

    </head>
      <body class="bs-docs-home">
        <a class="sr-only" href="#content">Skip navigation</a>

        <!-- Docs master nav -->
        <header class="navbar navbar-inverse navbar-fixed-top bs-docs-nav" role="banner">
          <div class="container">
            <div class="navbar-header">
              <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a href="/" class="navbar-brand">Haraka</a>
            </div>
            <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
              <ul class="nav navbar-nav">
                <li>
                  <a href="/about.html">About</a>
                </li>
                <li>
                  <a href="/community.html">Community</a>
                </li>
                <li>
                  <a href="/users.html">Known Users</a>
                </li>
                <li>
                  <a href="https://github.com/haraka/Haraka">Source on Github</a>
                </li>
                <li class="active">
                  <a href="/manual.html">Manual</a>
                </li>
              </ul>
            </nav>
          </div>
        </header>
        
        <!-- Docs page layout -->
        <div class="bs-header" id="content">
          <div class="container">
            <h1>Plugins</h1>
          </div>
        </div>
        
        <div class="container bs-docs-container">
          <div class="row">
            <div class="col-md-3">
              <div id="chapternav" class="bs-sidebar hidden-print" role="complementary">
                <ul class="nav bs-sidenav"><li><a class="submenu" data-toggle="collapse" data-target="#core" data-parent="#chapternav" href="javascript:void(null);">Core</a>
<ul id='core' class='nav'>
<li><a href='/UPGRADE.html'>2016.02.13</a></li>
<li><a href='/.github/CONTRIBUTING.html'>Haraka</a></li>
<li><a href='/.github/ISSUE_TEMPLATE.html'>Haraka</a></li>
<li><a href='/.github/PULL_REQUEST_TEMPLATE.html'>Haraka</a></li>
<li><a href='/manual/Body.html'>Body Object</a></li>
<li><a href='/manual/Config.html'>Config Files</a></li>
<li><a href='/manual/Connection.html'>Connection Object</a></li>
<li><a href='/manual/CoreConfig.html'>Core Configuration Files</a></li>
<li><a href='/manual/CustomReturnCodes.html'>Custom Return Codes</a></li>
<li><a href='/manual/deprecated/data.nomsgid.html'>data.nomsgid</a></li>
<li><a href='/manual/deprecated/data.noreceived.html'>data.noreceived</a></li>
<li><a href='/manual/deprecated/data.rfc5322_header_checks.html'>data.rfc5322_header_checks</a></li>
<li><a href='/manual/deprecated/lookup_rdns.strict.html'>lookup_rdns.strict</a></li>
<li><a href='/manual/deprecated/mail_from.blocklist.html'>mail_from.blocklist</a></li>
<li><a href='/manual/deprecated/mail_from.nobounces.html'>mail_from.nobounces</a></li>
<li><a href='/manual/deprecated/rcpt_to.blocklist.html'>rcpt_to.blocklist</a></li>
<li><a href='/manual/deprecated/rdns.regexp.html'>rdns.regexp</a></li>
<li><a href='/manual/HAProxy.html'>HAProxy PROXY protocol extension support</a></li>
<li><a href='/manual/Header.html'>Header Object</a></li>
<li><a href='/manual/Logging_API.html'>Logging API</a></li>
<li><a href='/manual/Net_Utils.html'>Net_Utils</a></li>
<li><a href='/manual/Outbound.html'>Outbound Mail with Haraka</a></li>
<li class="active"><a href='/manual/Plugins.html'>Plugins</a></li>
<li><a href='/manual/Results.html'>Results</a></li>
<li><a href='/manual/Transaction.html'>Transaction Object</a></li>
</ul></li>
<li><a class="submenu" data-toggle="collapse" data-target="#tutorials" data-parent="#chapternav" href="javascript:void(null);">Tutorials</a>
<ul id='tutorials' class='nav'>
<li><a href='/manual/Tutorial.html'>Writing Haraka Plugins</a></li>
<li><a href='/README.html'>Haraka</a></li>
<li><a href='/manual/tutorials/Migrating_from_v1_to_v2.html'>Migrating from Haraka v1.x to v2.x</a></li>
<li><a href='/manual/tutorials/SettingUpOutbound.html'>Configuring Haraka For Outbound Email</a></li>
</ul></li>
<li><a class="submenu" data-toggle="collapse" data-target="#plugins" data-parent="#chapternav" href="javascript:void(null);">Plugins</a>
<ul id='plugins' class='nav'>
<li><a href='/manual/plugins/auth/auth_bridge.html'>auth/auth_bridge</a></li>
<li><a href='/manual/plugins/auth/auth_ldap.html'>auth/auth_ldap</a></li>
<li><a href='/manual/plugins/auth/auth_proxy.html'>auth/auth_proxy</a></li>
<li><a href='/manual/plugins/auth/auth_vpopmaild.html'>auth/auth_vpopmaild</a></li>
<li><a href='/manual/plugins/auth/flat_file.html'>auth/flat_file</a></li>
<li><a href='/manual/plugins/queue/deliver.html'>queue/deliver</a></li>
<li><a href='/manual/plugins/queue/discard.html'>discard</a></li>
<li><a href='/manual/plugins/queue/lmtp.html'>queue/lmtp</a></li>
<li><a href='/manual/plugins/queue/qmail-queue.html'>queue/qmail-queue</a></li>
<li><a href='/manual/plugins/queue/quarantine.html'>quarantine</a></li>
<li><a href='/manual/plugins/queue/rabbitmq.html'>queue/rabbitmq</a></li>
<li><a href='/manual/plugins/queue/rabbitmq_amqplib.html'>queue/rabbitmq_amqplib</a></li>
<li><a href='/manual/plugins/queue/smtp_bridge.html'>queue/smtp_bridge</a></li>
<li><a href='/manual/plugins/queue/smtp_forward.html'>queue/smtp_forward</a></li>
<li><a href='/manual/plugins/queue/smtp_proxy.html'>queue/smtp_proxy</a></li>
<li><a href='/manual/plugins/access.html'>access - ACLs</a></li>
<li><a href='/manual/plugins/aliases.html'>aliases</a></li>
<li><a href='/manual/plugins/attachment.html'>attachment</a></li>
<li><a href='/manual/plugins/avg.html'>avg - Anti-Virus scanner</a></li>
<li><a href='/manual/plugins/backscatterer.html'>backscatterer</a></li>
<li><a href='/manual/plugins/block_me.html'>block_me</a></li>
<li><a href='/manual/plugins/bounce.html'>bounce</a></li>
<li><a href='/manual/plugins/clamd.html'>clamd</a></li>
<li><a href='/manual/plugins/connect.asn.html'>connect.asn - get AS number of remote</a></li>
<li><a href='/manual/plugins/connect.fcrdns.html'>connect.fcrdns - Forward Confirmed Reverse DNS</a></li>
<li><a href='/manual/plugins/connect.geoip.html'>geoip</a></li>
<li><a href='/manual/plugins/connect.p0f.html'>connect.p0f - TCP Fingerprinting</a></li>
<li><a href='/manual/plugins/connect.rdns_access.html'>connect.rdns_access</a></li>
<li><a href='/manual/plugins/daemonize.html'>daemonize</a></li>
<li><a href='/manual/plugins/data.headers.html'>data.headers</a></li>
<li><a href='/manual/plugins/data.signatures.html'>data.signatures</a></li>
<li><a href='/manual/plugins/data.uribl.html'>data.uribl</a></li>
<li><a href='/manual/plugins/dcc.html'>Haraka</a></li>
<li><a href='/manual/plugins/delay_deny.html'>delay_deny</a></li>
<li><a href='/manual/plugins/dkim_sign.html'>Haraka</a></li>
<li><a href='/manual/plugins/dkim_verify.html'>dkim_verify</a></li>
<li><a href='/manual/plugins/dnsbl.html'>dnsbl</a></li>
<li><a href='/manual/plugins/dnswl.html'>dnswl</a></li>
<li><a href='/manual/plugins/early_talker.html'>early_talker</a></li>
<li><a href='/manual/plugins/esets.html'>Haraka</a></li>
<li><a href='/manual/plugins/graph.html'>graph</a></li>
<li><a href='/manual/plugins/greylist.html'>Greylist</a></li>
<li><a href='/manual/plugins/helo.checks.html'>helo.checks</a></li>
<li><a href='/manual/plugins/karma.html'>karma - a scoring engine</a></li>
<li><a href='/manual/plugins/limit.html'>limit</a></li>
<li><a href='/manual/plugins/log.elasticsearch.html'>log.elasticsearch</a></li>
<li><a href='/manual/plugins/log.syslog.html'>log.syslog</a></li>
<li><a href='/manual/plugins/mail_from.access.html'>mail_from.access</a></li>
<li><a href='/manual/plugins/mail_from.is_resolvable.html'>mail_from.is_resolvable</a></li>
<li><a href='/manual/plugins/max_unrecognized_commands.html'>max_unrecognized_commands</a></li>
<li><a href='/manual/plugins/messagesniffer.html'>messagesniffer</a></li>
<li><a href='/manual/plugins/prevent_credential_leaks.html'>prevent_credential_leaks</a></li>
<li><a href='/manual/plugins/process_title.html'>process_title</a></li>
<li><a href='/manual/plugins/rate_limit.html'>rate_limit</a></li>
<li><a href='/manual/plugins/rcpt_to.access.html'>rcpt_to.access</a></li>
<li><a href='/manual/plugins/rcpt_to.in_host_list.html'>rcpt_to.in_host_list</a></li>
<li><a href='/manual/plugins/rcpt_to.ldap.html'>Haraka</a></li>
<li><a href='/manual/plugins/rcpt_to.max_count.html'>rcpt_to.max_count</a></li>
<li><a href='/manual/plugins/rcpt_to.qmail_deliverable.html'>rcpt_to.qmail_deliverable</a></li>
<li><a href='/manual/plugins/rcpt_to.routes.html'>Haraka</a></li>
<li><a href='/manual/plugins/record_envelope_addresses.html'>record</a></li>
<li><a href='/manual/plugins/redis.html'>redis</a></li>
<li><a href='/manual/plugins/relay.html'>relay</a></li>
<li><a href='/manual/plugins/relay_acl.html'>relay_acl</a></li>
<li><a href='/manual/plugins/relay_all.html'>relay_all</a></li>
<li><a href='/manual/plugins/relay_force_routing.html'>relay_force_routing.js</a></li>
<li><a href='/manual/plugins/reseed_rng.html'>reseed_rng</a></li>
<li><a href='/manual/plugins/rspamd.html'>rspamd</a></li>
<li><a href='/manual/plugins/spamassassin.html'>spamassassin</a></li>
<li><a href='/manual/plugins/spf.html'>spf</a></li>
<li><a href='/manual/plugins/tarpit.html'>tarpit</a></li>
<li><a href='/manual/plugins/tls.html'>tls</a></li>
<li><a href='/manual/plugins/toobusy.html'>toobusy</a></li>
<li><a href='/manual/plugins/watch.html'>watch - smtp connections in HTTP browser</a></li>
<li><a href='/manual/plugins/xclient.html'>xclient</a></li>
</ul></li></ul>

              </div>
            </div>
            
            <div class="col-md-9" role="main">
              <div class="bs-docs-section">
                <h1>Plugins</h1>

<p>All aspects of receiving an email in Haraka are controlled via plugins. No
mail can even be received unless at least a 'rcpt' and 'queue' plugin are
enabled.</p>

<p>Recipient (<em>rcpt</em>) plugins determine if a particular recipient is allowed to be relayed or received for. A <em>queue</em> plugin queues the message somewhere - normally to disk or to an another SMTP server.</p>

<p>Get a list of built-in plugins by running:</p>

<p><code>haraka -l -c /path/to/config</code></p>

<p>Display the help text for a plugin by running:</p>

<p><code>haraka -h &lt;name&gt; -c /path/to/config</code></p>

<p>Omit the <code>-c /path/to/config</code> to see only the plugins supplied with Haraka
(not your local plugins in your <code>config</code> directory).</p>

<h1>Writing Haraka Plugins</h1>

<h2>Anatomy of a Plugin</h2>

<p>Plugins in Haraka are Javascript files or modules in the plugins/ directory.
Alternatively they can be npm-style node<em>modules in either the core node</em>modules
folder, or the folder you gave to <code>haraka -i &lt;folder&gt;</code>. See "Plugins as Modules"
below for more information on this.</p>

<p>To enable a plugin, add its name to <code>config/plugins</code>.</p>

<h2>Register a Hook</h2>

<p>There are two ways for plugins to register hooks. Both examples register a function on the <em>rcpt</em> hook:</p>

<ol>
<li><p>The <code>register_hook</code> function in register():</p>

<p>exports.register = function() {
    this.register<em>hook('rcpt', 'my</em>rcpt_validate');
};</p>

<p>exports.my<em>rcpt</em>validate = function (next, connection, params) {
    // do processing
    next();
};</p></li>
<li><p>The hook_[$name] syntax:</p>

<p>exports.hook_rcpt = function (next, connection, params) {
    // do processing
    next();
};</p></li>
</ol>

<h3>Register a Hook Multiple Times</h3>

<p>To register the same hook more than once, call <code>register_hook()</code> multiple times with the same hook name:</p>

<pre><code>exports.register = function() {
    this.register_hook('queue', 'try_queue_my_way');
    this.register_hook('queue', 'try_queue_highway');
};
</code></pre>

<p>When <code>try_queue_my_way()</code> calls <code>next()</code>, the next function registered on hook <em>queue</em> will be called, in this case, <code>try_queue_highway()</code>.</p>

<h4>Determine hook name</h4>

<p>When a single function runs on multiple hooks, the function can check the
<em>hook</em> property of the <em>connection</em> or <em>hmail</em> argument to determine which hook it is running on:</p>

<pre><code>exports.register = function() {
    this.register_hook('rcpt',    'my_rcpt');
    this.register_hook('rcpt_ok', 'my_rcpt');
};

exports.my_rcpt = function (next, connection, params) {
    var hook_name = connection.hook; // rcpt or rcpt_ok
    // email address is in params[0]
    // do processing
}
</code></pre>

<h3>Next()</h3>

<p>After registering a hook, functions are called with that hooks arguments (see <strong>Available Hooks</strong> below. The first argument is a callback function, conventionally named <code>next</code>. When the function is completed, it calls <code>next()</code> and the connection continues. Failing to call <code>next()</code> will result in the connection hanging until that plugin's timer expires.</p>

<p><code>next([code, msg])</code> accepts two optional parameters:</p>

<ol>
<li><code>code</code> is one of the listed return codes.</li>
<li><code>msg</code> is a string to send to the client in case of a failure. Use an array to send a multi-line message. <code>msg</code> should NOT contain the code number - that is handled by Haraka.</li>
</ol>

<h4>Next() Return Codes</h4>

<p>These constants are in your plugin when it is loaded, you do not
need to define them:</p>

<ul>
<li><p>CONT</p>

<p>Continue and let other plugins handle this particular hook. This is the
default. These are identical: <code>next()</code> and <code>next(CONT)</code>;</p></li>
<li><p>DENY - Reject with a 5xx error.</p></li>
<li><p>DENYSOFT - Reject with a 4xx error.</p></li>
<li><p>DENYDISCONNECT - Reject with a 5xx error and immediately disconnect.</p></li>
<li><p>DISCONNECT - Immediately disconnect</p></li>
<li><p>OK</p>

<p>Required by <code>rcpt</code> plugins to accept a recipient and <code>queue</code> plugins when the queue was successful.</p>

<p>After a plugin calls <code>next(OK)</code>, no further plugins on that hook will run.</p>

<p>Exceptions to next(OK):</p>

<ul>
<li><p>connect_init and disconnect hooks are <strong>always called</strong>.</p></li>
<li><p>On the deny hook, <code>next(OK)</code> overrides the default CONT.</p></li>
</ul></li>
<li><p>HOOK_NEXT</p>

<p>HOOK_NEXT is only available on the <code>unrecognized_command</code> hook. It instructs Haraka to run a different plugin hook. The <code>msg</code> argument must be set to the name of the hook to be run. Ex: <code>next(HOOK_NEXT, 'rcpt_ok');</code></p></li>
</ul>

<h2>Available Hooks</h2>

<p>These are the hook and their parameters (next excluded):</p>

<ul>
<li>init_master - called when the main (master) process is started</li>
<li>init_child - in cluster, called when a child process is started</li>
<li>init_http - called when Haraka is started.</li>
<li>init<em>wss - called after init</em>http</li>
<li>connect_init - used to init data structures, called for <em>every</em> connection</li>
<li>lookup_rdns - called to look up the rDNS - return the rDNS via <code>next(OK, rdns)</code></li>
<li>connect - called after we got rDNS</li>
<li>capabilities - called to get the ESMTP capabilities (such as STARTTLS)</li>
<li>unrecognized_command - called when the remote end sends a command we don't recognise</li>
<li>disconnect - called upon disconnect</li>
<li>helo (hostname)</li>
<li>ehlo (hostname)</li>
<li>quit</li>
<li>vrfy</li>
<li>noop</li>
<li>rset</li>
<li>mail ([from, esmtp_params])</li>
<li>rcpt ([to,   esmtp_params])</li>
<li>rcpt_ok (to)</li>
<li>data - called at the DATA command</li>
<li>data_post - called at the end-of-data marker</li>
<li>max_data_exceeded - called when the message exceeds connection.max_bytes</li>
<li>queue - called to queue the mail</li>
<li>queue_outbound - called to queue the mail when connection.relaying is set</li>
<li>queue_ok - called when a mail has been queued successfully</li>
<li>reset_transaction - called before the transaction is reset (via RSET, or MAIL)</li>
<li>deny - called when a plugin returns DENY, DENYSOFT or DENYDISCONNECT</li>
<li>get_mx (hmail, domain) - called by outbound to resolve the MX record</li>
<li>deferred (hmail, params) - called when an outbound message is deferred</li>
<li>bounce (hmail, err) - called when an outbound message bounces</li>
<li>delivered (hmail, [host, ip, response, delay, port, mode, ok_recips, secured, authenticated]) - called when outbound mail is delivered</li>
<li>send_email (hmail) - called when outbound is about to be sent</li>
</ul>

<h3>rcpt</h3>

<p>The <em>rcpt</em> hook is slightly special.</p>

<p>When <strong>connection.relaying == false</strong> (the default, to avoid being an open relay), a rcpt plugin MUST return <code>next(OK)</code> or the sender will receive the error message "I cannot deliver for that user". The default <em>rcpt</em> plugin  is <strong>rcpt<em>to.in</em>host_list</strong>, which lists the domains for which to accept email.</p>

<p>After a <em>rcpt</em> plugin calls <code>next(OK)</code>, the <em>rcpt_ok</em> hook is run.</p>

<p>If a plugin prior to the <em>rcpt</em> hook sets <strong>connection.relaying = true</strong>, then it is not necessary for a rcpt plugin to call <code>next(OK)</code>.</p>

<h3>connect_init</h3>

<p>The <code>connect_init</code> hook is unique in that all return codes are ignored. This is so that plugins that need to do initialization for every connection can be assured they will run. Return values are ignored.</p>

<h3>hook<em>init</em>http (next, Server)</h3>

<p>If http listeners are are enabled in http.ini and the express module loaded, the express library will be located at Server.http.express. More importantly, the express <a href="http://expressjs.com/4x/api.html#app">app / instance</a> will be located at Server.http.app. Plugins can register routes on the app just as they would with any <a href="http://expressjs.com/">Express.js</a> app.</p>

<h3>hook<em>init</em>wss (next, Server)</h3>

<p>If express loaded, an attempt is made to load <a href="https://www.npmjs.com/package/ws">ws</a>, the websocket server. If it succeeds, the wss server will be located at Server.http.wss. Because of how websockets work, only one websocket plugin will work at a time. One plugin using wss is <a href="https://github.com/haraka/Haraka/tree/master/plugins/watch">watch</a>.</p>

<h2>Hook Order</h2>

<p>The ordering of hooks is determined by the SMTP protocol. Knowledge of <a href="http://tools.ietf.org/html/rfc5321">RFC 5321</a> is beneficial.</p>

<h5>Typical Inbound Connection</h5>

<ul>
<li>hook<em>connect</em>init</li>
<li>hook<em>lookup</em>rdns</li>
<li>hook_connect</li>
<li>hook<em>helo <strong>OR</strong> hook</em>ehlo (EHLO is sent when ESMTP is desired which allows extensions
such as STARTTLS, AUTH, SIZE etc.)
<ul>
<li>hook<em>helo</li>
<li>hook<em>ehlo
<ul>
<li>hook</em>capabilities</li>
<li><em>hook<em>unrecognized</em>command</em> is run for each ESMTP extension the client requests
e.g. STARTTLS, AUTH etc.)</li>
</ul></li>
<li>hook</em>mail</li>
<li>hook<em>rcpt (once per-recipient)</li>
<li>hook<em>rcpt</em>ok (for every recipient that hook</em>rcpt returned <code>next(OK)</code> for)</li>
<li>hook<em>data</li>
<li><em>[attachment hooks]</em></li>
<li>hook<em>data</em>post</li>
<li>hook<em>queue <strong>OR</strong> hook</em>queue</em>outbound</li>
<li>hook<em>queue</em>ok (called if hook<em>queue or hook</em>queue_outbound returns <code>next(OK)</code>)</li>
</ul></li>
<li>hook<em>quit <strong>OR</strong> hook</em>rset <strong>OR</strong> hook<em>helo <strong>OR</strong> hook</em>ehlo (after a message has been sent or rejected, the client can disconnect or start a new transaction with RSET, EHLO or HELO)
<ul>
<li>hook<em>reset</em>transaction</li>
</ul></li>
<li>hook_disconnect</li>
</ul>

<h5>Typical Outbound mail</h5>

<p>By 'outbound' we mean messages using Haraka's built-in queue and delivery
mechanism. The Outbound queue is used when <code>connection.relaying = true</code> is set during the  transaction and <code>hook_queue_outbound</code> is called to queue the message.</p>

<p>The Outbound hook ordering mirrors the Inbound hook order above until after <code>hook_queue_outbound</code>, which is followed by:</p>

<ul>
<li>hook<em>send</em>email</li>
<li>hook<em>get</em>mx</li>
<li>at least one of:
<ul>
<li>hook<em>delivered  (once per delivery domain with at least one successfull recipient)</li>
<li>hook</em>deferred  (once per delivery domain where at least one recipient or connection was deferred)</li>
<li>hook_bounce  (once per delivery domain where the recipient(s) or message was rejected by the destination)</li>
</ul></li>
</ul>

<h1>Plugin Run Order</h1>

<p>Plugins are run on each hook in the order that they are specified in <code>config/plugins</code>. When a plugin returns anything other than <code>next()</code> on a hook, all subsequent plugins due to run on that hook are skipped (exceptions: connect_init, disconnect).</p>

<p>This is important as some plugins might rely on <code>results</code> or <code>notes</code> that have been set by plugins that need to run before them. This should be noted in the plugins documentation. Make sure to read it.</p>

<p>If you are writing a complex plugin, you may have to split it into multiple plugins to run in a specific order e.g. you want hook<em>deny to run last after all other plugins and hook</em>lookup_rdns to run first, then you can explicitly register your hooks and provide a <code>priority</code> value which is an integer between -100 (highest priority) to 100 (lowest priority) which defaults to 0 (zero) if not supplied.  You can apply a priority to your hook in the following way:</p>

<p><code>
exports.register = function() {
    var plugin = this;
    plugin.register_hook('connect',  'hook_connect', -100);
}
</code></p>

<p>This would ensure that your hook_connect function will run before any other
plugins registered on the <code>connect</code> hook, regardless of the order it was
specified in <code>config/plugins</code>.</p>

<p>Check the order that the plugins will run on each hook by running:</p>

<p><code>haraka -o -c /path/to/config</code></p>

<h2>Logging</h2>

<p>Plugins inherit all the logging methods of <code>logger.js</code>, which are:</p>

<ul>
<li>logprotocol</li>
<li>logdebug</li>
<li>loginfo</li>
<li>lognotice</li>
<li>logwarn</li>
<li>logerror</li>
<li>logcrit</li>
<li>logalert</li>
<li>logemerg</li>
</ul>

<p>If plugins throw an exception when in a hook, the exception will be caught
and generate a logcrit level error. However, exceptions will not be caught
as gracefully when plugins are running async code. Use error codes for that,
log the error, and run your next() function appropriately.</p>

<h2>Sharing State</h2>

<p>There are several cases where you might need to share information between
plugins.  This is done using <code>notes</code> - there are three types available:</p>

<ul>
<li><p>server.notes</p>

<p>Available in all plugins.  This is created at PID start-up and is shared
amongst all plugins on the same PID and listener.
Typical uses for notes at this level would be to share database
connections between multiple plugins or connection pools etc.</p></li>
<li><p>connection.notes</p>

<p>Available on any hook that passes 'connection' as a function parameter.
This is shared amongst all plugins for a single connection and is
destroyed after the client disconnects.
Typical uses for notes at this level would be to store information
about the connected client e.g. rDNS names, HELO/EHLO, white/black
list status etc.</p></li>
<li><p>connection.transaction.notes</p>

<p>Available on any hook that passes 'connection' as a function parameter
between hook_mail and hook_data_post.
This is shared amongst all plugins for this transaction (e.g. MAIL FROM
through until a message is received or the connection is reset).
Typical uses for notes at this level would be to store information
on things like greylisting which uses client, sender and recipient
information etc.</p></li>
<li><p>hmail.todo.notes</p>

<p>Available on any outbound hook that passes <code>hmail</code> as a function parameter.
This is the same object as 'connection.transaction.notes', so anything
you store in the transaction notes is automatically available in the
outbound functions here.</p></li>
</ul>

<p>All of these notes are Javascript objects - use them as simple key/value store e.g.</p>

<pre><code>connection.transaction.notes.test = 'testing';
</code></pre>

<h2>Plugins as Modules</h2>

<p>Plugins loaded as modules behave slightly differently to plugins loaded from
<code>plugins/</code> as plain javascript files.</p>

<p>Plain javascript plugins have a customized version of <code>require()</code> which allows
you to load core Haraka modules via specifying <code>require('./name')</code> (note the
<code>./</code> prefix). Although the core modules aren't in the same folder, we intercept
this and look for core modules. Note that if there is a module in your plugins
folder of the same name that will not take preference, so avoid using names
similar to core modules.</p>

<p>Plugins loaded as modules do not have this special <code>require()</code>. In order to load
a core Haraka module you will have to use <code>this.core_require('name')</code>. Note that
this should be preferred anyway for plain javascript plugins anyway, as the
<code>./</code> hack is likely to go away in the future.</p>

<p>Plugins loaded as modules also are not compiled inside the Haraka plugin sandbox,
which provides some security benefits, but also blocks access to certain globals,
and provides a global <code>server</code> object. To access the <code>server</code> object, use
<code>connection.server</code> instead.</p>

<p>Module plugins support default config in their local <code>config</code> directory. See the
"Default Config and Overrides" section in <a href="Config.md">Config</a>.</p>

<h2>See also, <a href="Results.md">Results</a></h2>

<h2>Further Reading</h2>

<p>Read about the <a href="Connection.md">Connection</a> object.</p>

<p>Outbound hooks are <a href="Outbound.md">also documented</a>.</p>

              </div>
            </div>
          </div>
        </div>

        <footer class="container" role="contentinfo">
            <ul class="bs-masthead-links">
            <li>
            <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
            <input type="hidden" name="cmd" value="_s-xclick">
            <input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----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-----END PKCS7-----
            ">
            <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
            <img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
            </form>
            </li>
            </ul>
        </footer>
        
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="/js/jquery.js"></script>
        <script src="/js/bootstrap.js"></script>
        <script src="/js/holder.js"></script>
        <!-- <script src="/js/application.js"></script> -->
        <script>
        $('.bs-sidebar ul ul').each(function (i, el) {
            if (!$(el).find('li.active').length) {
                $(el).collapse('toggle');
            }
        });
        $('a.submenu').on('touchstart', function(e) { e.stopPropagation(); });
        </script>

    </body>
</html>
